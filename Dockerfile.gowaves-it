FROM golang:1.25-alpine3.22@sha256:d9c983d2ac66c3f43208dfb6b092dd1296baa058766e3aa88a1b233adeb416c1 as builder
LABEL wavesplatform-gowaves-itests-tmp=true
WORKDIR /app

RUN apk add --no-cache make musl-dev gcc git

COPY go.mod .
COPY go.sum .

RUN go mod download

COPY .git .git
RUN git restore --source=HEAD --worktree .
COPY go.mod .
COPY go.sum .
COPY Makefile .
COPY cmd cmd
COPY pkg pkg

ARG WITH_RACE_SUFFIX=""
RUN make build-node-native${WITH_RACE_SUFFIX}

FROM alpine:3.23@sha256:865b95f46d98cf867a156fe4a135ad3fe50d2056aa3f25ed31662dff6da4eb62
ENV TZ=Etc/UTC \
    APP_USER=gowaves

RUN apk add --no-cache bind-tools curl

RUN addgroup -S $APP_USER \
    && adduser -S $APP_USER -G $APP_USER

RUN mkdir -p /home/gowaves/config /home/gowaves/wallet

ENV CONFIG_PATH=/home/gowaves/config/gowaves-it.json \
    STATE_PATH=/home/gowaves/  \
    WALLET_PATH=/home/gowaves/wallet/go.wallet


USER $APP_USER

COPY --from=builder /app/build/bin/native/node /app/node

HEALTHCHECK CMD curl -f http://localhost:6869/node/status || exit 1

STOPSIGNAL SIGINT

CMD /app/node \
    -cfg-path=$CONFIG_PATH \
    -peers=$PEERS \
    -state-path=$STATE_PATH \
    -wallet-path=$WALLET_PATH \
    -wallet-password=$WALLET_PASSWORD \
    -blockchain-type=custom \
    -enable-grpc-api=true \
    -grpc-address=$GRPC_ADDR \
    -api-address=$API_ADDR \
    -api-key=itest-api-key \
    -declared-address=$DECLARED_ADDR \
    -bind-address=$BIND_ADDR \
    -build-extended-api \
    -build-state-hashes \
    -serve-extended-api \
    -log-type=prettydev \
    -log-level=debug \
    -log-network \
    -log-fsm \
    -obsolescence=1h \
    -reward=$DESIRED_REWARD \
    -vote=$SUPPORTED_FEATURES \
    -disable-ntp \
    -microblock-interval 2s \
    -blacklist-residence-time 0 \
    -rate-limiter-opts="rps=100&burst=100" \
    -min-peers-mining=$QUORUM \
    -disable-miner=$DISABLE_MINER \
